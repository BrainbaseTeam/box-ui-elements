{"version":3,"sources":["../../../src/api/box-edit/ActiveXChannel.js"],"names":["Browser","Channel","CONSTANTS","MAX_RETRY_ATTEMPTS","ActiveXChannel","appName","isSynchronous","operationType","data","browserToComServerTimeoutMS","comServerToApplicationTimeoutSec","Promise","resolve","reject","details","buildDetailsObj","timeoutId","setTimeout","Error","status_code","REQUEST_TIMEOUT_RESPONSE_CODE","reqIdToPromiseMap","set","req_id","rejectTimeout","executeActiveXEvent","detail","payload","isIEAndSpecificBrowserPluginSupported","BOX_TOOLS_PLUGIN_NAME","retryAttempt","activeX","createActiveXObjectJSRef","hasExecuteSyncAPI","ExecuteSync","JSON","stringify","Execute","ex","repairActiveXConnection","ActiveXObject","window","isActiveXExtensionListenerAttached","document","addEventListener","OUTPUT_EVENT","appExtensionEventResponseHandler","removeEventListener","responseVal","response","parse","has","resolveObj","get","clearTimeout","delete","responseData","com_server_response","executeOperation","OPERATION_STATUS","OPERATION_REQUEST","OPERATION_COMMAND","tearDownActiveXCommunication","channelName","ACTIVEX_CHANNEL_NAME","Map","setupActiveXCommunication"],"mappings":"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","sourcesContent":["// @flow\nimport Browser from './BrowserUtils';\nimport Channel from './Channel';\nimport CONSTANTS from './constants';\n\nconst MAX_RETRY_ATTEMPTS = 2;\n\nclass ActiveXChannel extends Channel {\n    isSynchronous: boolean;\n\n    isActiveXExtensionListenerAttached: boolean;\n\n    retryAttempt: number;\n\n    reqIdToPromiseMap: Map<string, Object>;\n\n    window: any;\n\n    document: Document;\n\n    constructor(appName: string, isSynchronous: boolean) {\n        super(appName);\n        this.isSynchronous = isSynchronous;\n        this.channelName = CONSTANTS.ACTIVEX_CHANNEL_NAME;\n        this.reqIdToPromiseMap = new Map();\n        this.isActiveXExtensionListenerAttached = false;\n        this.retryAttempt = 0;\n        this.document = document;\n        this.window = window;\n        this.setupActiveXCommunication();\n    }\n\n    executeOperation = (\n        operationType: string = '',\n        data: ?Object = {},\n        browserToComServerTimeoutMS: number = 0,\n        comServerToApplicationTimeoutSec: number = 0,\n    ): Promise<any> => {\n        return new Promise((resolve, reject) => {\n            const details = this.buildDetailsObj(operationType, data, comServerToApplicationTimeoutSec);\n\n            const timeoutId = setTimeout(() => {\n                reject(\n                    new Error({\n                        status_code: CONSTANTS.REQUEST_TIMEOUT_RESPONSE_CODE,\n                    }),\n                );\n            }, browserToComServerTimeoutMS);\n\n            this.reqIdToPromiseMap.set(details.req_id, {\n                resolve,\n                rejectTimeout: timeoutId,\n            });\n            this.executeActiveXEvent({ detail: details });\n        });\n    };\n\n    repairActiveXConnection = (payload: Object) => {\n        if (!Browser.isIEAndSpecificBrowserPluginSupported(CONSTANTS.BOX_TOOLS_PLUGIN_NAME)) {\n            return;\n        }\n\n        if (this.retryAttempt >= MAX_RETRY_ATTEMPTS) {\n            return;\n        }\n\n        this.retryAttempt += 1;\n\n        setTimeout(() => {\n            this.executeActiveXEvent(payload);\n        }, 100);\n    };\n\n    executeActiveXEvent = (payload: Object) => {\n        const activeX = this.createActiveXObjectJSRef();\n        const hasExecuteSyncAPI = 'ExecuteSync' in activeX;\n\n        try {\n            if (this.isSynchronous && hasExecuteSyncAPI) {\n                activeX.ExecuteSync(JSON.stringify(payload));\n            } else {\n                activeX.Execute(JSON.stringify(payload));\n            }\n        } catch (ex) {\n            this.repairActiveXConnection(payload);\n        }\n    };\n\n    createActiveXObjectJSRef = () => {\n        const { ActiveXObject } = this.window;\n        return new ActiveXObject(CONSTANTS.BOX_TOOLS_PLUGIN_NAME);\n    };\n\n    setupActiveXCommunication = () => {\n        if (!this.isActiveXExtensionListenerAttached) {\n            // attach the event listener to App Extension output events\n            this.document.addEventListener(CONSTANTS.OUTPUT_EVENT, this.appExtensionEventResponseHandler);\n            this.isActiveXExtensionListenerAttached = true;\n        }\n    };\n\n    tearDownActiveXCommunication = () => {\n        if (this.isActiveXExtensionListenerAttached) {\n            // remove the event listener for App Extension output events\n            this.document.removeEventListener(CONSTANTS.OUTPUT_EVENT, this.appExtensionEventResponseHandler);\n            this.isActiveXExtensionListenerAttached = false;\n        }\n    };\n\n    appExtensionEventResponseHandler = (responseVal: any) => {\n        if (this.retryAttempt > 0) {\n            this.retryAttempt = 0;\n        }\n\n        const response: Object =\n            typeof responseVal.detail === 'string' ? JSON.parse(responseVal.detail) : responseVal.detail;\n\n        if (this.reqIdToPromiseMap.has(response.req_id)) {\n            const resolveObj = this.reqIdToPromiseMap.get(response.req_id);\n            if (resolveObj) {\n                clearTimeout(resolveObj.rejectTimeout);\n                this.reqIdToPromiseMap.delete(response.req_id);\n\n                const responseData =\n                    typeof response.com_server_response.data === 'string'\n                        ? JSON.parse(response.com_server_response.data)\n                        : response.com_server_response.data;\n\n                resolveObj.resolve(responseData);\n            }\n        }\n    };\n\n    getComServerStatus = (browserToComServerTimeoutMS: number, comServerToApplicationTimeoutSec: number) => {\n        return this.executeOperation(\n            CONSTANTS.OPERATION_STATUS,\n            null,\n            browserToComServerTimeoutMS,\n            comServerToApplicationTimeoutSec,\n        );\n    };\n\n    sendRequest = (data: Object, browserToComServerTimeoutMS: number, comServerToApplicationTimeoutSec: number) => {\n        return this.executeOperation(\n            CONSTANTS.OPERATION_REQUEST,\n            data,\n            browserToComServerTimeoutMS,\n            comServerToApplicationTimeoutSec,\n        );\n    };\n\n    sendCommand = (data: Object, browserToComServerTimeoutMS: number, comServerToApplicationTimeoutSec: number) => {\n        return this.executeOperation(\n            CONSTANTS.OPERATION_COMMAND,\n            data,\n            browserToComServerTimeoutMS,\n            comServerToApplicationTimeoutSec,\n        );\n    };\n\n    destroy = () => {\n        this.tearDownActiveXCommunication();\n    };\n}\n\nexport { MAX_RETRY_ATTEMPTS };\nexport default ActiveXChannel;\n"],"file":"ActiveXChannel.js"}