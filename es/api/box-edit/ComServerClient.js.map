{"version":3,"sources":["../../../src/api/box-edit/ComServerClient.js"],"names":["Browser","BROWSER_CONSTANTS","promiseOne","ActiveXChannel","Channel","HTTPChannel","SafariChannel","CONSTANTS","MIN_FIREFOX_VERSION_FOR_MIXED_CONTENT","MIN_EDGE_16_VERSION_FOR_MIXED_CONTENT","MIN_EDGE_VERSION_FOR_MIXED_CONTENT","REQUEST_TIMEOUT_MS","boxToolsLogData","createHTTPChannel","appName","BOX_UNSECURE_LOCAL_BASE_URL","CREATED_STATUS","HTTP_CHANNEL_NAME","http_channel_status","createSafariChannel","safari_channel_status","createActiveXChannel","activex_channel_status","createSynchronousActiveXChannel","isSupportedMSEdgeVersion","EDGE","isMinBrowser","getVersion","startsWith","isUnsupportedMSEdgeVersion","isEdge","isMixedContentAllowedOnLocalhost","CHROME","FIREFOX","isSupportedSafariVersion","SAFARI","isUnsupportedSafariVersion","isSafari","isFirefoxWithExtensionsCapability","isFirefox","isSupportedIEVersion","IE","isSupportedIEAndBoxToolsPluginAvailable","isIEAndSpecificBrowserPluginSupported","BOX_TOOLS_PLUGIN_NAME","comServerErrorGenerator","reject","BOX_EDIT_NOT_SUPPORTED_ERROR","BOX_EDIT_SAFARI_ERROR","BOX_EDIT_UNINSTALLED_ERROR","BOX_EDIT_UPGRADE_BROWSER_ERROR","errorMessageID","isChrome","error_message","Error","validateAndReturnBrowserToComServerTimeout","customTimeoutMS","timeoutMS","Math","floor","shortenAndReturnComServerToApplicationTimeout","browserToComServerTimeoutMS","timeoutSec","toFixed","initBoxToolsLogData","browserName","getName","browserVersion","UNCREATED_STATUS","box_tools_version","browser_name","browser_version","installation_type","https_channel_status","ComServerClient","channels","isInitialized","push","concat","ACTIVE_STATUS","comServerToApplicationTimeoutSec","shouldRejectPromiseDueToUnSupportedMSEdgeOrVersion","Promise","resolve","call","length","map","channel","getComServerStatus","then","res","activeChannel","version","channelName","catch","bind","requestData","isSynchronous","sendRequest","data","sendCommand"],"mappings":"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","sourcesContent":["// @flow\n\nimport Browser, { BROWSER_CONSTANTS } from './BrowserUtils';\n\nimport promiseOne from './promise';\nimport ActiveXChannel from './ActiveXChannel';\nimport Channel from './Channel';\nimport HTTPChannel from './HTTPChannel';\nimport SafariChannel from './SafariChannel';\nimport CONSTANTS from './constants';\n\nconst MIN_FIREFOX_VERSION_FOR_MIXED_CONTENT = 55;\nconst MIN_EDGE_16_VERSION_FOR_MIXED_CONTENT = '16.16299';\nconst MIN_EDGE_VERSION_FOR_MIXED_CONTENT = '17.17134';\nconst REQUEST_TIMEOUT_MS = 5000;\n\nlet boxToolsLogData: {\n    activex_channel_status: string,\n    box_tools_version: ?string,\n    browser_name: string,\n    browser_version: string,\n    error_message: ?string,\n    http_channel_status: string,\n    https_channel_status: string,\n    installation_type: ?string,\n    safari_channel_status: string,\n};\n\nfunction createHTTPChannel(appName: string): HTTPChannel {\n    const { BOX_UNSECURE_LOCAL_BASE_URL, CREATED_STATUS, HTTP_CHANNEL_NAME } = CONSTANTS;\n\n    boxToolsLogData.http_channel_status = CREATED_STATUS;\n\n    return new HTTPChannel(appName, BOX_UNSECURE_LOCAL_BASE_URL, HTTP_CHANNEL_NAME);\n}\n\nfunction createSafariChannel(appName: string): SafariChannel {\n    const { CREATED_STATUS } = CONSTANTS;\n\n    boxToolsLogData.safari_channel_status = CREATED_STATUS;\n\n    return new SafariChannel(appName);\n}\n\nfunction createActiveXChannel(appName: string): ActiveXChannel {\n    const { CREATED_STATUS } = CONSTANTS;\n\n    boxToolsLogData.activex_channel_status = CREATED_STATUS;\n\n    return new ActiveXChannel(appName, false);\n}\n\n/**\n * Returns an instance of the ActiveX Channel that runs commands in the ActiveX process synchronously.\n * This is required for running in certain embedded IE-based webviews.\n */\nfunction createSynchronousActiveXChannel(appName): ActiveXChannel {\n    const { CREATED_STATUS } = CONSTANTS;\n\n    boxToolsLogData.activex_channel_status = CREATED_STATUS;\n    return new ActiveXChannel(appName, true);\n}\n\n/**\n * Returns TRUE for MS Edge versions 17.17692+ OR\n * Returns TRUE for MS Edge version 16 greater than 16.16299\n * @returns {boolean}\n */\nfunction isSupportedMSEdgeVersion() {\n    const { EDGE } = BROWSER_CONSTANTS;\n    return (\n        Browser.isMinBrowser(EDGE, MIN_EDGE_VERSION_FOR_MIXED_CONTENT) ||\n        (Browser.isMinBrowser(EDGE, MIN_EDGE_16_VERSION_FOR_MIXED_CONTENT) && Browser.getVersion().startsWith('16.'))\n    );\n}\n\nfunction isUnsupportedMSEdgeVersion() {\n    return Browser.isEdge() && !isSupportedMSEdgeVersion();\n}\n\nfunction isMixedContentAllowedOnLocalhost() {\n    const { CHROME, FIREFOX } = BROWSER_CONSTANTS;\n    // TODO can we do this with feature detection rather than sniffing?\n    return (\n        Browser.isMinBrowser(CHROME, 53) ||\n        Browser.isMinBrowser(FIREFOX, MIN_FIREFOX_VERSION_FOR_MIXED_CONTENT) ||\n        isSupportedMSEdgeVersion()\n    );\n}\n\nfunction isSupportedSafariVersion() {\n    return Browser.isMinBrowser(BROWSER_CONSTANTS.SAFARI, 10);\n}\n\nfunction isUnsupportedSafariVersion() {\n    return Browser.isSafari() && !isSupportedSafariVersion();\n}\n\n/**\n * @TODO: (2018-07-24) Rename this to isFirefoxWithoutMixedContentCapability\n * since we do not have an Extension planned for the Firefox versions below 55.\n */\nfunction isFirefoxWithExtensionsCapability() {\n    return (\n        Browser.isFirefox() && !Browser.isMinBrowser(BROWSER_CONSTANTS.FIREFOX, MIN_FIREFOX_VERSION_FOR_MIXED_CONTENT)\n    );\n}\n\n/**\n * Checks if the IE version is supported\n * @returns {boolean}\n */\nfunction isSupportedIEVersion() {\n    return Browser.isMinBrowser(BROWSER_CONSTANTS.IE, 11);\n}\n\n/**\n * Checks if the user is on IE 11 and has a specific ActiveXObject plugin loaded on the page\n */\nfunction isSupportedIEAndBoxToolsPluginAvailable() {\n    // Browser Plugins Support is the check for ActiveX-like plugins\n    return isSupportedIEVersion() && Browser.isIEAndSpecificBrowserPluginSupported(CONSTANTS.BOX_TOOLS_PLUGIN_NAME);\n}\n\n/**\n * Analyze the cause of Channel failure and return a rejected Promise with an error message\n */\nfunction comServerErrorGenerator(reject) {\n    const {\n        BOX_EDIT_NOT_SUPPORTED_ERROR,\n        BOX_EDIT_SAFARI_ERROR,\n        BOX_EDIT_UNINSTALLED_ERROR,\n        BOX_EDIT_UPGRADE_BROWSER_ERROR,\n    } = CONSTANTS;\n    let errorMessageID = BOX_EDIT_NOT_SUPPORTED_ERROR;\n\n    if (isMixedContentAllowedOnLocalhost()) {\n        errorMessageID = BOX_EDIT_UNINSTALLED_ERROR;\n    } else if (isSupportedIEVersion()) {\n        errorMessageID = BOX_EDIT_UNINSTALLED_ERROR;\n    } else if (\n        Browser.isFirefox() ||\n        Browser.isChrome() ||\n        isUnsupportedSafariVersion() ||\n        isUnsupportedMSEdgeVersion()\n        // Show UPGRADE message when MS Edge support has been enabled\n    ) {\n        errorMessageID = BOX_EDIT_UPGRADE_BROWSER_ERROR;\n    } else if (isSupportedSafariVersion()) {\n        errorMessageID = BOX_EDIT_SAFARI_ERROR;\n    }\n\n    boxToolsLogData.error_message = errorMessageID;\n    return reject(new Error(errorMessageID));\n}\n\n/**\n * Default returns the timeout value of 5000ms, if a timeout is not passed.\n * When passed validates it to be a number and parse it to the lower integer value\n *\n * @param {number} [customTimeoutMS] optional field to override the timeout value passed in miliseconds\n * @returns {number}\n */\nfunction validateAndReturnBrowserToComServerTimeout(customTimeoutMS) {\n    let timeoutMS = REQUEST_TIMEOUT_MS;\n\n    // validate timeout is a positive number\n    if (typeof customTimeoutMS === 'number' && customTimeoutMS >= 0) {\n        timeoutMS = Math.floor(customTimeoutMS);\n    }\n\n    return timeoutMS;\n}\n\n/**\n * Returns reduced timeout converted to seconds\n * We need to use a shortened timeout for the connection between local com server and application,\n * so that we will receive a message that that connection has timed out,\n * before the connection between the browser and the local com server itself times out.\n */\nfunction shortenAndReturnComServerToApplicationTimeout(browserToComServerTimeoutMS) {\n    let timeoutSec = +(browserToComServerTimeoutMS / 1000).toFixed(2);\n\n    if (browserToComServerTimeoutMS < 2) {\n        timeoutSec /= 2;\n    } else {\n        timeoutSec -= 1;\n    }\n\n    return timeoutSec;\n}\n\nfunction initBoxToolsLogData() {\n    const browserName = Browser.getName();\n    const browserVersion = Browser.getVersion();\n    const { UNCREATED_STATUS } = CONSTANTS;\n\n    boxToolsLogData = {\n        box_tools_version: null,\n        browser_name: browserName,\n        browser_version: browserVersion,\n        error_message: null,\n        installation_type: null,\n        http_channel_status: UNCREATED_STATUS,\n        https_channel_status: UNCREATED_STATUS,\n        activex_channel_status: UNCREATED_STATUS,\n        safari_channel_status: UNCREATED_STATUS,\n    };\n}\n\nclass ComServerClient {\n    activeChannel: Channel;\n\n    channels: Array<Channel>;\n\n    isInitialized: boolean = false;\n\n    browser: string;\n\n    constructor(appName: string) {\n        this.channels = [];\n\n        this.isInitialized = true;\n        initBoxToolsLogData();\n\n        if (isMixedContentAllowedOnLocalhost()) {\n            this.channels.push(createHTTPChannel(appName));\n        } else if (isSupportedSafariVersion()) {\n            this.channels.push(createSafariChannel(appName));\n        } else if (isSupportedIEAndBoxToolsPluginAvailable()) {\n            this.channels.push(createActiveXChannel(appName));\n        } else if (isFirefoxWithExtensionsCapability() || isUnsupportedMSEdgeVersion()) {\n            // @NOTE (2018-07-24) No Action - Trying all channels is not an option in this case\n            // @TODO (2018-07-24) Remove this empty case from here?\n        } else {\n            // @NOTE: (2018-01-16) Trying all channels in case of custom useragent\n            this.channels = this.channels.concat([\n                createHTTPChannel(appName),\n                createSafariChannel(appName),\n                createSynchronousActiveXChannel(appName),\n            ]);\n        }\n    }\n\n    getComServerStatus(customTimeoutMS: ?number): Promise<any> {\n        const { ACTIVE_STATUS } = CONSTANTS;\n\n        const browserToComServerTimeoutMS = validateAndReturnBrowserToComServerTimeout(customTimeoutMS);\n        const comServerToApplicationTimeoutSec = shortenAndReturnComServerToApplicationTimeout(\n            browserToComServerTimeoutMS,\n        );\n\n        const shouldRejectPromiseDueToUnSupportedMSEdgeOrVersion = isUnsupportedMSEdgeVersion();\n\n        return new Promise((resolve, reject) => {\n            if (shouldRejectPromiseDueToUnSupportedMSEdgeOrVersion) {\n                return comServerErrorGenerator.call(null, reject);\n            }\n\n            if (!this.channels.length) {\n                return comServerErrorGenerator.call(null, reject);\n            }\n\n            return promiseOne(\n                this.channels.map(channel => {\n                    return channel\n                        .getComServerStatus(browserToComServerTimeoutMS, comServerToApplicationTimeoutSec)\n                        .then(res => {\n                            this.activeChannel = channel;\n\n                            if (res) {\n                                boxToolsLogData.installation_type = res.installation_type;\n                                boxToolsLogData.box_tools_version = res.version;\n                            }\n\n                            boxToolsLogData[`${channel.channelName}_status`] = ACTIVE_STATUS;\n                            return resolve(res);\n                        });\n                }),\n            ).catch(comServerErrorGenerator.bind(null, reject));\n        });\n    }\n\n    // TODO isSynchronous? do we need it?\n    sendRequest(requestData: string, isSynchronous: ?boolean, customTimeoutMS: ?number): Object {\n        const browserToComServerTimeoutMS = validateAndReturnBrowserToComServerTimeout(customTimeoutMS);\n        const comServerToApplicationTimeoutSec = shortenAndReturnComServerToApplicationTimeout(\n            browserToComServerTimeoutMS,\n        );\n\n        if (this.activeChannel) {\n            return this.activeChannel.sendRequest(\n                requestData,\n                browserToComServerTimeoutMS,\n                comServerToApplicationTimeoutSec,\n            );\n        }\n\n        return this.getComServerStatus().then(() => {\n            return this.activeChannel.sendRequest(\n                requestData,\n                browserToComServerTimeoutMS,\n                comServerToApplicationTimeoutSec,\n            );\n        });\n    }\n\n    sendCommand(data: string, customTimeoutMS: number): Promise<any> {\n        const browserToComServerTimeoutMS = validateAndReturnBrowserToComServerTimeout(customTimeoutMS);\n        const comServerToApplicationTimeoutSec = shortenAndReturnComServerToApplicationTimeout(\n            browserToComServerTimeoutMS,\n        );\n\n        if (this.activeChannel) {\n            return this.activeChannel.sendCommand(data, browserToComServerTimeoutMS, comServerToApplicationTimeoutSec);\n        }\n\n        return this.getComServerStatus().then(() => {\n            return this.activeChannel.sendCommand(data, browserToComServerTimeoutMS, comServerToApplicationTimeoutSec);\n        });\n    }\n}\n\nexport default ComServerClient;\n"],"file":"ComServerClient.js"}