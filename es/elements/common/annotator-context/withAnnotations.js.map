{"version":3,"sources":["../../../../src/elements/common/annotator-context/withAnnotations.tsx"],"names":["React","getProp","generatePath","matchPath","AnnotatorContext","Action","Status","ANNOTATIONS_PATH","defaultState","action","activeAnnotationFileVersionId","activeAnnotationId","annotation","error","meta","withAnnotations","WrappedComponent","ComponentWithAnnotations","props","id","annotator","emit","eventData","onError","showNotification","setState","state","getAction","annotationId","fileVersionId","addListener","handleActiveChange","handleAnnotationCreate","handleAnnotationFetchError","shouldReset","removeListener","location","match","getMatchPath","status","SUCCESS","CREATE_END","CREATE_START","sidebar","undefined","pathname","path","exact","emitActiveChangeEvent","emitRemoveEvent","getAnnotationsMatchPath","getAnnotationsPath","handleAnnotator","handlePreviewDestroy","Component","displayName","name"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport getProp from 'lodash/get';\nimport { generatePath, match as matchType, matchPath } from 'react-router-dom';\nimport { Location } from 'history';\nimport AnnotatorContext from './AnnotatorContext';\nimport { Action, Annotator, AnnotationActionEvent, AnnotatorState, GetMatchPath, MatchParams, Status } from './types';\n\nexport type ActiveChangeEvent = {\n    annotationId: string | null;\n    fileVersionId: string;\n};\n\nexport type ActiveChangeEventHandler = (event: ActiveChangeEvent) => void;\n\nexport type ComponentWithAnnotations = {\n    emitActiveChangeEvent: (id: string | null) => void;\n    emitRemoveEvent: (id: string) => void;\n    getAction: (eventData: AnnotationActionEvent) => Action;\n    getAnnotationsPath: (fileVersionId?: string, annotationId?: string | null) => string;\n    getMatchPath: GetMatchPath;\n    handleActiveChange: ActiveChangeEventHandler;\n    handleAnnotationChangeEvent: (id: string | null) => void;\n    handleAnnotationCreate: (eventData: AnnotationActionEvent) => void;\n    handleAnnotationFetchError: ({ error }: { error: Error }) => void;\n    handleAnnotator: (annotator: Annotator) => void;\n    handlePreviewDestroy: (shouldReset?: boolean) => void;\n};\n\nexport type WithAnnotationsProps = {\n    location?: Location;\n    onAnnotator: (annotator: Annotator) => void;\n    onError?: (error: Error, code: string, contextInfo?: Record<string, unknown>) => void;\n    onPreviewDestroy: (shouldReset?: boolean) => void;\n};\n\nexport type WithAnnotationsComponent<P> = React.ComponentClass<P & WithAnnotationsProps>;\n\nconst ANNOTATIONS_PATH = '/:sidebar/annotations/:fileVersionId/:annotationId?';\nconst defaultState: AnnotatorState = {\n    action: null,\n    activeAnnotationFileVersionId: null,\n    activeAnnotationId: null,\n    annotation: null,\n    error: null,\n    meta: null,\n};\n\nexport default function withAnnotations<P extends object>(\n    WrappedComponent: React.ComponentType<P>,\n): WithAnnotationsComponent<P> {\n    class ComponentWithAnnotations extends React.Component<P & WithAnnotationsProps, AnnotatorState> {\n        static displayName: string;\n\n        annotator: Annotator | null = null;\n\n        constructor(props: P & WithAnnotationsProps) {\n            super(props);\n\n            // Determine by url if there is already a deeply linked annotation\n            const { location } = props;\n            const match = this.getMatchPath(location);\n            const activeAnnotationId = getProp(match, 'params.annotationId', null);\n\n            // Seed the initial state with the activeAnnotationId if any from the location path\n            this.state = { ...defaultState, activeAnnotationId };\n        }\n\n        emitActiveChangeEvent = (id: string | null) => {\n            const { annotator } = this;\n\n            if (!annotator) {\n                return;\n            }\n\n            annotator.emit('annotations_active_set', id);\n        };\n\n        emitRemoveEvent = (id: string) => {\n            const { annotator } = this;\n\n            if (!annotator) {\n                return;\n            }\n\n            annotator.emit('annotations_remove', id);\n        };\n\n        getAction({ meta: { status }, error }: AnnotationActionEvent): Action {\n            return status === Status.SUCCESS || error ? Action.CREATE_END : Action.CREATE_START;\n        }\n\n        getAnnotationsPath(fileVersionId?: string, annotationId?: string | null): string {\n            if (!fileVersionId) {\n                return '/activity';\n            }\n\n            return generatePath(ANNOTATIONS_PATH, {\n                sidebar: 'activity',\n                annotationId: annotationId || undefined,\n                fileVersionId,\n            });\n        }\n\n        getMatchPath(location?: Location): matchType<MatchParams> | null {\n            const pathname = getProp(location, 'pathname', '');\n            return matchPath<MatchParams>(pathname, {\n                path: ANNOTATIONS_PATH,\n                exact: true,\n            });\n        }\n\n        handleAnnotationCreate = (eventData: AnnotationActionEvent): void => {\n            const { annotation = null, error = null, meta = null } = eventData;\n            const { onError } = this.props;\n\n            if (onError && error) {\n                onError(error, 'create_annotation_error', { showNotification: true });\n            }\n\n            this.setState({\n                ...this.state,\n                action: this.getAction(eventData),\n                annotation,\n                error,\n                meta,\n            });\n        };\n\n        handleActiveChange: ActiveChangeEventHandler = ({ annotationId, fileVersionId }): void => {\n            this.setState({ activeAnnotationFileVersionId: fileVersionId, activeAnnotationId: annotationId });\n        };\n\n        handleAnnotationFetchError = ({ error }: { error: Error }): void => {\n            const { onError } = this.props;\n\n            if (onError && error) {\n                onError(error, 'fetch_annotations_error', { showNotification: true });\n            }\n        };\n\n        handleAnnotator = (annotator: Annotator): void => {\n            this.annotator = annotator;\n            this.annotator.addListener('annotations_active_change', this.handleActiveChange);\n            this.annotator.addListener('annotations_create', this.handleAnnotationCreate);\n            this.annotator.addListener('annotations_fetch_error', this.handleAnnotationFetchError);\n        };\n\n        handlePreviewDestroy = (shouldReset = true): void => {\n            if (shouldReset) {\n                this.setState(defaultState);\n            }\n\n            if (this.annotator) {\n                this.annotator.removeListener('annotations_active_change', this.handleActiveChange);\n                this.annotator.removeListener('annotations_create', this.handleAnnotationCreate);\n                this.annotator.removeListener('annotations_fetch_error', this.handleAnnotationFetchError);\n            }\n\n            this.annotator = null;\n        };\n\n        render(): JSX.Element {\n            return (\n                <AnnotatorContext.Provider\n                    value={{\n                        emitActiveChangeEvent: this.emitActiveChangeEvent,\n                        emitRemoveEvent: this.emitRemoveEvent,\n                        getAnnotationsMatchPath: this.getMatchPath,\n                        getAnnotationsPath: this.getAnnotationsPath,\n                        state: this.state,\n                    }}\n                >\n                    <WrappedComponent\n                        {...this.props}\n                        onAnnotator={this.handleAnnotator}\n                        onPreviewDestroy={this.handlePreviewDestroy}\n                    />\n                </AnnotatorContext.Provider>\n            );\n        }\n    }\n\n    const displayName = WrappedComponent.displayName || WrappedComponent.name || 'Component';\n    ComponentWithAnnotations.displayName = `WithAnnotations(${displayName})`;\n\n    return ComponentWithAnnotations;\n}\n"],"file":"withAnnotations.js"}